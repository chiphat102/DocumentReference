<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç—…äººç«¯æ–‡ä»¶ç®¡ç†ç³»çµ± - å®‰å…¨åˆ†æµç‰ˆ</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-50 p-6 md:p-10">
    <div class="max-w-4xl mx-auto bg-white p-8 rounded-2xl shadow-xl border border-gray-200">
        <h1 class="text-3xl font-bold mb-2 text-blue-600">é†«ç™‚æ–‡ä»¶ä¸Šå‚³ç³»çµ±</h1>
        <p class="text-gray-500 mb-8 pb-4 border-b">Token: FseRRShyS18wfOGwTkjqhE0QhMembX1oeODI é–‹é ­æ˜¯ ghp_ã€‚</p>

        <section class="mb-10">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6 bg-blue-50 p-6 rounded-xl">
                <div>
                    <label class="block text-sm font-semibold text-gray-600 mb-2">ç—…äºº ID (Subject)</label>
                    <input type="text" id="patientId" value="Patient/1326" class="w-full border p-2.5 rounded-lg outline-none focus:ring-2 focus:ring-blue-400">
                </div>
                <div>
                    <label class="block text-sm font-semibold text-gray-600 mb-2">ç§‘åˆ¥ (Category)</label>
                    <select id="category" class="w-full border p-2.5 rounded-lg outline-none focus:ring-2 focus:ring-blue-400">
                        <option value="Cardiology">å¿ƒè‡Ÿå…§ç§‘</option>
                        <option value="General">ä¸€èˆ¬å…§ç§‘</option>
                        <option value="Orthopedics">éª¨ç§‘</option>
                        <option value="Radiology">æ”¾å°„ç§‘</option>
                    </select>
                </div>
                <div class="md:col-span-2">
                    <label class="block text-sm font-semibold text-gray-600 mb-2">å ±å‘Šæ¨™é¡Œ (Title)</label>
                    <input type="text" id="docTitle" placeholder="ä¾‹å¦‚ï¼š2026å¹´å¿ƒé›»åœ–å ±å‘Š" class="w-full border p-2.5 rounded-lg outline-none focus:ring-2 focus:ring-blue-400">
                </div>
                <div class="md:col-span-2">
                    <label class="block text-sm font-semibold text-gray-600 mb-2">é¸æ“‡æª”æ¡ˆ</label>
                    <input type="file" id="fileInput" class="w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-blue-100 file:text-blue-700 hover:file:bg-blue-200">
                </div>
            </div>
            <button onclick="handleUpload()" class="mt-6 w-full bg-blue-600 text-white font-bold py-3 rounded-lg hover:bg-blue-700 shadow-lg transition transform active:scale-95">
                ğŸš€ é–‹å§‹ä¸Šå‚³ (ç³»çµ±å°‡è©¢å• Token)
            </button>
            <div id="status" class="mt-4 p-4 rounded-lg hidden text-sm font-medium"></div>
        </section>

        <section>
            <h2 class="text-xl font-bold mb-4 text-gray-700">æˆ‘çš„æ–‡ä»¶ç´€éŒ„</h2>
            <div class="overflow-hidden border border-gray-200 rounded-xl">
                <table class="w-full text-left">
                    <thead class="bg-gray-100">
                        <tr>
                            <th class="p-4 text-sm font-bold text-gray-600">æ¨™é¡Œ</th>
                            <th class="p-4 text-sm font-bold text-gray-600">ç§‘åˆ¥</th>
                            <th class="p-4 text-sm font-bold text-gray-600">æ—¥æœŸ</th>
                            <th class="p-4 text-sm font-bold text-gray-600">æ“ä½œ</th>
                        </tr>
                    </thead>
                    <tbody id="docList" class="divide-y divide-gray-100">
                        </tbody>
                </table>
            </div>
        </section>
    </div>

    <script>
        const CONFIG = {
            githubRepo: 'chiphat102/DocumentReference', // âš ï¸ è«‹ç¢ºèªå¸³è™Ÿèˆ‡å°ˆæ¡ˆå
            fhirBaseUrl: 'https://tzuchi-fhir.ddns.net/fhir'
        };

        async function handleUpload() {
            const fileInput = document.getElementById('fileInput');
            const title = document.getElementById('docTitle').value;
            const patientId = document.getElementById('patientId').value;
            const category = document.getElementById('category').value;
            
            if (!fileInput.files[0] || !title) return alert('è«‹å¡«å¯«æ¨™é¡Œä¸¦é¸æ“‡æª”æ¡ˆ');

            // --- ğŸ’¡ è§£æ±º 401 é—œéµï¼šå‹•æ…‹è©¢å• Token ---
            const userToken = prompt("è«‹è²¼å…¥æ‚¨çš„ GitHub Token (ghp_...)ï¼š\nç‚ºäº†å®‰å…¨ï¼Œæ­¤ Token ä¸æœƒå„²å­˜åœ¨ç¶²é åŸå§‹ç¢¼ä¸­ã€‚");
            if (!userToken) return;

            const file = fileInput.files[0];
            updateStatus("â³ æ­£åœ¨ä¸Šå‚³è‡³ GitHub...", "blue");

            try {
                // 1. æª”æ¡ˆè½‰ Base64
                const base64Data = await toBase64(file);
                const fileName = `${Date.now()}_${file.name.replace(/\s+/g, '_')}`;

                // 2. ä¸Šå‚³ GitHub
                const ghUrl = `https://api.github.com/repos/${CONFIG.githubRepo}/contents/uploads/${encodeURIComponent(fileName)}`;
                const ghRes = await fetch(ghUrl, {
                    method: 'PUT',
                    headers: {
                        'Authorization': `token ${userToken.trim()}`,
                        'Accept': 'application/vnd.github.v3+json',
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        message: `Upload: ${fileName}`,
                        content: base64Data.split(',')[1]
                    })
                });

                if (!ghRes.ok) {
                    const err = await ghRes.json();
                    throw new Error(`GitHub é©—è­‰å¤±æ•—: ${err.message}`);
                }

                const ghJson = await ghRes.json();
                updateStatus("âœ… GitHub æˆåŠŸï¼å»ºç«‹ FHIR ç´€éŒ„ä¸­...", "blue");

                // 3. å»ºç«‹ FHIR DocumentReference
                const fhirPayload = {
                    resourceType: "DocumentReference",
                    status: "current",
                    subject: { reference: patientId },
                    category: [{ text: category }],
                    content: [{
                        attachment: {
                            contentType: file.type,
                            url: ghJson.content.download_url,
                            title: title,
                            creation: new Date().toISOString()
                        }
                    }]
                };

                const fhirRes = await fetch(`${CONFIG.fhirBaseUrl}/DocumentReference`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/fhir+json' },
                    body: JSON.stringify(fhirPayload)
                });

                if (fhirRes.ok) {
                    updateStatus("ğŸ‰ å ±å‘Šå·²æˆåŠŸåŒæ­¥è‡³é†«ç™‚ç³»çµ±ï¼", "green");
                    fetchDocuments();
                } else {
                    throw new Error("FHIR ä¼ºæœå™¨å­˜å…¥å¤±æ•—ã€‚");
                }

            } catch (err) {
                updateStatus(`âŒ å¤±æ•—: ${err.message}`, "red");
            }
        }

        async function fetchDocuments() {
            const patientId = document.getElementById('patientId').value;
            const docList = document.getElementById('docList');
            try {
                const res = await fetch(`${CONFIG.fhirBaseUrl}/DocumentReference?subject=${patientId}&_sort=-_lastUpdated`);
                const bundle = await res.json();
                docList.innerHTML = '';
                if (bundle.entry) {
                    bundle.entry.forEach(item => {
                        const r = item.resource;
                        const a = r.content[0].attachment;
                        docList.innerHTML += `
                            <tr>
                                <td class="p-4 text-sm font-medium">${a.title}</td>
                                <td class="p-4 text-sm text-gray-500">${r.category?.[0]?.text || ''}</td>
                                <td class="p-4 text-sm text-gray-500">${new Date(a.creation).toLocaleDateString()}</td>
                                <td class="p-4"><a href="${a.url}" target="_blank" class="text-blue-600 font-bold">æŸ¥çœ‹</a></td>
                            </tr>`;
                    });
                }
            } catch (e) { console.error(e); }
        }

        const toBase64 = file => new Promise((resolve, reject) => {
            const reader = new FileReader();
            reader.readAsDataURL(file);
            reader.onload = () => resolve(reader.result);
            reader.onerror = e => reject(e);
        });

        function updateStatus(msg, color) {
            const div = document.getElementById('status');
            div.className = `mt-4 p-4 rounded-lg block font-medium `;
            if(color === "blue") div.classList.add("bg-blue-50", "text-blue-700");
            if(color === "green") div.classList.add("bg-green-50", "text-green-700");
            if(color === "red") div.classList.add("bg-red-50", "text-red-700");
            div.innerText = msg;
            div.classList.remove('hidden');
        }

        window.onload = fetchDocuments;
    </script>
</body>
</html>
