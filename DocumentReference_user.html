<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç—…äººç«¯æ–‡ä»¶ç®¡ç†ç³»çµ±</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-50 p-8">
    <div class="max-w-4xl mx-auto bg-white p-6 rounded-lg shadow-md">
        <h1 class="text-2xl font-bold mb-6 text-blue-600">ç—…äººæ–‡ä»¶è‡ªå‚³èˆ‡æŸ¥è©¢ç³»çµ±</h1>

        <section class="mb-10 border-b pb-8">
            <h2 class="text-xl font-semibold mb-4 text-gray-700">ç¬¬ä¸€æ­¥ï¼šä¸Šå‚³å ±å‘Š (GitHub & FHIR)</h2>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                    <label class="block text-sm font-medium text-gray-600">ç—…äºº ID (Subject)</label>
                    <input type="text" id="patientId" value="Patient/1326" class="w-full border p-2 rounded focus:ring-2 focus:ring-blue-400 outline-none">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-600">ç§‘åˆ¥ (Category)</label>
                    <select id="category" class="w-full border p-2 rounded focus:ring-2 focus:ring-blue-400 outline-none">
                        <option value="Cardiology">å¿ƒè‡Ÿå…§ç§‘</option>
                        <option value="General">ä¸€èˆ¬å…§ç§‘</option>
                        <option value="Orthopedics">éª¨ç§‘</option>
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-600">æ–‡ä»¶æ¨™é¡Œ (Title)</label>
                    <input type="text" id="docTitle" placeholder="ä¾‹å¦‚ï¼š2026å¹´åº¦å¥æª¢å ±å‘Š" class="w-full border p-2 rounded focus:ring-2 focus:ring-blue-400 outline-none">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-600">é¸æ“‡æª”æ¡ˆ</label>
                    <input type="file" id="fileInput" class="w-full border p-1 rounded">
                </div>
            </div>
            <button onclick="handleUpload()" id="uploadBtn" class="mt-4 bg-blue-500 text-white px-6 py-2 rounded hover:bg-blue-600 transition duration-200">
                åŸ·è¡Œä¸Šå‚³ä¸¦å»ºç«‹ FHIR ç´€éŒ„
            </button>
            <p id="status" class="mt-2 text-sm font-semibold"></p>
        </section>

        <section>
            <h2 class="text-xl font-semibold mb-4 text-gray-700">ç¬¬äºŒæ­¥ï¼šèª¿é–±æˆ‘çš„æ–‡ä»¶</h2>
            <div class="flex gap-4 mb-4">
                <button onclick="fetchDocuments()" class="bg-green-500 text-white px-4 py-2 rounded hover:bg-green-600 transition duration-200">
                    é‡æ–°æ•´ç†åˆ—è¡¨
                </button>
            </div>
            <div class="overflow-x-auto">
                <table class="w-full border-collapse border border-gray-200">
                    <thead>
                        <tr class="bg-gray-100">
                            <th class="border p-2">æ¨™é¡Œ</th>
                            <th class="border p-2">ç§‘åˆ¥</th>
                            <th class="border p-2">æ—¥æœŸ</th>
                            <th class="border p-2">æ“ä½œ</th>
                        </tr>
                    </thead>
                    <tbody id="docList" class="text-center">
                        </tbody>
                </table>
            </div>
        </section>
    </div>

    <script>
        // ã€é‡è¦è¨­å®šã€‘è«‹å‹™å¿…å¡«å¯«æ­£ç¢º
        const CONFIG = {
            githubToken: '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', // è«‹æ›´æ›ç‚ºå¯ç”¨çš„ Token
            githubRepo: 'ä½ çš„å¸³è™Ÿ/ä½ çš„å°ˆæ¡ˆå',  // å¿…é ˆæ˜¯ "å¸³è™Ÿ/å°ˆæ¡ˆ" æ ¼å¼
            fhirBaseUrl: 'https://tzuchi-fhir.ddns.net/fhir'
        };

        // 1. è™•ç†ä¸Šå‚³é‚è¼¯
        async function handleUpload() {
            const fileInput = document.getElementById('fileInput');
            const title = document.getElementById('docTitle').value;
            const patientId = document.getElementById('patientId').value;
            const category = document.getElementById('category').value;
            const status = document.getElementById('status');

            if (!fileInput.files[0] || !title) return alert('è«‹é¸æ“‡æª”æ¡ˆä¸¦å¡«å¯«æ¨™é¡Œ');
            
            status.className = "mt-2 text-sm text-blue-600";
            status.innerText = "â³ æ­£åœ¨è™•ç†æª”æ¡ˆä¸¦ä¸Šå‚³è‡³ GitHub...";
            
            const file = fileInput.files[0];

            try {
                // A. è½‰ç‚º Base64 (æ ¸å¿ƒä¿®æ­£ï¼šè£œä¸Šéºå¤±çš„ base64 è½‰æ›)
                const base64Content = await toBase64(file);
                const fileName = `${Date.now()}_${file.name.replace(/\s+/g, '_')}`;
                
                // B. ä¸Šå‚³è‡³ GitHub (è·¯å¾‘ä¿®æ­£)
                const ghUrl = `https://api.github.com/repos/${CONFIG.githubRepo}/contents/uploads/${encodeURIComponent(fileName)}`;

                const ghRes = await fetch(ghUrl, {
                    method: 'PUT',
                    headers: {
                        'Authorization': `token ${CONFIG.githubToken}`,
                        'Accept': 'application/vnd.github.v3+json',
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        message: `Upload ${fileName} from Patient App`,
                        content: base64Content.split(',')[1] // ç§»é™¤ Base64 Data URL å‰ç¶´
                    })
                });

                if (!ghRes.ok) {
                    const errorMsg = await ghRes.json();
                    throw new Error(`GitHub ä¸Šå‚³å¤±æ•—: ${errorMsg.message}`);
                }

                const ghData = await ghRes.json();
                const downloadUrl = ghData.content.download_url;

                // C. å»ºç«‹ FHIR DocumentReference
                status.innerText = "âœ… GitHub ä¸Šå‚³æˆåŠŸï¼Œæ­£åœ¨å»ºç«‹ FHIR ç´€éŒ„...";
                const docRef = {
                    resourceType: "DocumentReference",
                    status: "current",
                    subject: { reference: patientId },
                    category: [{ text: category }],
                    content: [{
                        attachment: {
                            contentType: file.type,
                            url: downloadUrl,
                            title: title,
                            creation: new Date().toISOString()
                        }
                    }]
                };

                const fhirRes = await fetch(`${CONFIG.fhirBaseUrl}/DocumentReference`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/fhir+json' },
                    body: JSON.stringify(docRef)
                });

                if (fhirRes.ok) {
                    status.className = "mt-2 text-sm text-green-600";
                    status.innerText = "ğŸ‰ å…¨éƒ¨æµç¨‹å®Œæˆï¼ç´€éŒ„å·²å„²å­˜ã€‚";
                    fetchDocuments(); // æ›´æ–°åˆ—è¡¨
                } else {
                    throw new Error("FHIR ä¼ºæœå™¨å»ºç«‹ç´€éŒ„å¤±æ•—");
                }

            } catch (err) {
                status.className = "mt-2 text-sm text-red-600";
                status.innerText = "âŒ éŒ¯èª¤: " + err.message;
                console.error(err);
            }
        }

        // 2. ç²å–æ–‡ä»¶åˆ—è¡¨
        async function fetchDocuments() {
            const patientId = document.getElementById('patientId').value;
            const tbody = document.getElementById('docList');
            
            try {
                const res = await fetch(`${CONFIG.fhirBaseUrl}/DocumentReference?subject=${patientId}&_sort=-_lastUpdated`);
                const bundle = await res.json();
                
                tbody.innerHTML = '';

                if (bundle.entry && bundle.entry.length > 0) {
                    bundle.entry.forEach(item => {
                        const doc = item.resource;
                        const attachment = doc.content[0].attachment;
                        const row = `
                            <tr class="hover:bg-gray-50">
                                <td class="border p-2">${attachment.title || 'ç„¡æ¨™é¡Œ'}</td>
                                <td class="border p-2">${doc.category?.[0]?.text || 'æœªåˆ†é¡'}</td>
                                <td class="border p-2">${attachment.creation ? new Date(attachment.creation).toLocaleDateString() : 'N/A'}</td>
                                <td class="border p-2">
                                    <a href="${attachment.url}" target="_blank" class="text-blue-500 font-bold hover:underline">æª¢è¦–æª”æ¡ˆ</a>
                                </td>
                            </tr>
                        `;
                        tbody.innerHTML += row;
                    });
                } else {
                    tbody.innerHTML = '<tr><td colspan="4" class="p-4 text-gray-500">æš«ç„¡ç›¸é—œå ±å‘Š</td></tr>';
                }
            } catch (err) {
                console.error("Fetch error:", err);
            }
        }

        // å·¥å…·ï¼šæª”æ¡ˆè½‰ Base64
        const toBase64 = file => new Promise((resolve, reject) => {
            const reader = new FileReader();
            reader.readAsDataURL(file);
            reader.onload = () => resolve(reader.result);
            reader.onerror = error => reject(error);
        });

        // é é¢è¼‰å…¥æ™‚å…ˆåŸ·è¡Œä¸€æ¬¡æŸ¥è©¢
        window.onload = fetchDocuments;
    </script>
</body>
</html>
