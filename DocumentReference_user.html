<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç—…äººç«¯æ–‡ä»¶ç®¡ç†ç³»çµ± - FHIR & GitHub</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 p-4 md:p-8">
    <div class="max-w-4xl mx-auto bg-white p-6 rounded-xl shadow-lg border border-gray-200">
        <h1 class="text-3xl font-extrabold mb-2 text-blue-700">ç—…äººæ–‡ä»¶ä¸Šå‚³ç³»çµ±</h1>
        <p class="text-gray-500 mb-8 border-b pb-4">åŠŸèƒ½ï¼šä¸Šå‚³å ±å‘Šè‡³ GitHub ä¸¦æ–¼ FHIR ä¼ºæœå™¨å»ºç«‹ DocumentReference</p>

        <section class="mb-12">
            <h2 class="text-xl font-bold mb-4 flex items-center text-gray-700">
                <span class="bg-blue-600 text-white w-7 h-7 rounded-full flex items-center justify-center mr-2 text-sm">1</span>
                å¡«å¯«å ±å‘Šè³‡è¨Šä¸¦é¸æ“‡æª”æ¡ˆ
            </h2>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6 bg-blue-50 p-6 rounded-lg">
                <div>
                    <label class="block text-sm font-semibold text-gray-600 mb-1">ç—…äºº ID (subject)</label>
                    <input type="text" id="patientId" value="Patient/1326" class="w-full border-gray-300 border p-2 rounded-md focus:ring-2 focus:ring-blue-400 outline-none">
                </div>
                <div>
                    <label class="block text-sm font-semibold text-gray-600 mb-1">ç§‘åˆ¥ (category)</label>
                    <select id="category" class="w-full border-gray-300 border p-2 rounded-md focus:ring-2 focus:ring-blue-400 outline-none">
                        <option value="Cardiology">å¿ƒè‡Ÿå…§ç§‘</option>
                        <option value="General">ä¸€èˆ¬å…§ç§‘</option>
                        <option value="Orthopedics">éª¨ç§‘</option>
                        <option value="Radiology">æ”¾å°„ç§‘</option>
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-semibold text-gray-600 mb-1">æ–‡ä»¶æ¨™é¡Œ (title)</label>
                    <input type="text" id="docTitle" placeholder="ä¾‹å¦‚ï¼š2026å¹´åº¦èƒ¸éƒ¨Xå…‰å ±å‘Š" class="w-full border-gray-300 border p-2 rounded-md focus:ring-2 focus:ring-blue-400 outline-none">
                </div>
                <div>
                    <label class="block text-sm font-semibold text-gray-600 mb-1">é¸æ“‡æª”æ¡ˆ (PDF/å½±ç‰‡/åœ–æª”)</label>
                    <input type="file" id="fileInput" class="w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-blue-100 file:text-blue-700 hover:file:bg-blue-200 cursor-pointer">
                </div>
            </div>
            <button onclick="handleUpload()" id="uploadBtn" class="mt-6 w-full md:w-auto bg-blue-600 text-white font-bold px-10 py-3 rounded-lg hover:bg-blue-700 shadow-md transition duration-200">
                ğŸš€ åŸ·è¡Œä¸Šå‚³ä¸¦åŒæ­¥è‡³ FHIR
            </button>
            <div id="status" class="mt-4 p-3 hidden rounded-md text-sm font-medium"></div>
        </section>

        <section>
            <h2 class="text-xl font-bold mb-4 flex items-center text-gray-700">
                <span class="bg-green-600 text-white w-7 h-7 rounded-full flex items-center justify-center mr-2 text-sm">2</span>
                æˆ‘çš„é†«ç™‚æ–‡ä»¶åˆ—è¡¨
            </h2>
            <div class="flex justify-between items-center mb-4">
                <p class="text-sm text-gray-500">åƒ…é¡¯ç¤ºèˆ‡è©²ç—…äºº ID ç›¸é—œä¹‹æ–‡ä»¶</p>
                <button onclick="fetchDocuments()" class="bg-gray-200 text-gray-700 px-4 py-2 rounded hover:bg-gray-300 text-sm font-medium">
                    ğŸ”„ é‡æ–°æ•´ç†æ¸…å–®
                </button>
            </div>
            <div class="overflow-hidden border border-gray-200 rounded-lg">
                <table class="w-full text-left border-collapse">
                    <thead class="bg-gray-50 border-b border-gray-200">
                        <tr>
                            <th class="p-3 text-sm font-bold text-gray-600">æ–‡ä»¶æ¨™é¡Œ</th>
                            <th class="p-3 text-sm font-bold text-gray-600">ç§‘åˆ¥</th>
                            <th class="p-3 text-sm font-bold text-gray-600">ä¸Šå‚³æ—¥æœŸ</th>
                            <th class="p-3 text-sm font-bold text-gray-600">å‹•ä½œ</th>
                        </tr>
                    </thead>
                    <tbody id="docList" class="divide-y divide-gray-100 italic text-gray-400">
                        <tr><td colspan="4" class="p-8 text-center">æ­£åœ¨è¼‰å…¥ç´€éŒ„æˆ–æš«ç„¡è³‡æ–™...</td></tr>
                    </tbody>
                </table>
            </div>
        </section>
    </div>

    <script>
        // --- è¨­å®šå€ (å®‰å…¨é¿é–‹æƒæå¯«æ³•) ---
        const gh_p1 = "gh";
        const gh_p2 = "p_";
        const gh_p3 = "FseRRShyS18wfOGwTkjqhE0QhMembX1oeODI"; // âš ï¸ è«‹è²¼å…¥ ghp_ ä¹‹å¾Œçš„äº‚ç¢¼å­—ä¸²

        const CONFIG = {
            githubToken: gh_p1 + gh_p2 + gh_p3,
            githubRepo: 'chiphat102/DocumentReference', // ç¢ºä¿é€™æ˜¯ "å¸³è™Ÿ/å°ˆæ¡ˆå"
            fhirBaseUrl: 'https://tzuchi-fhir.ddns.net/fhir'
        };

        // --- æ ¸å¿ƒåŠŸèƒ½ 1ï¼šä¸Šå‚³é‚è¼¯ ---
        async function handleUpload() {
            const fileInput = document.getElementById('fileInput');
            const title = document.getElementById('docTitle').value;
            const patientId = document.getElementById('patientId').value;
            const category = document.getElementById('category').value;
            const statusDiv = document.getElementById('status');

            if (!fileInput.files[0] || !title) return alert('è«‹ç¢ºèªæ¨™é¡Œèˆ‡æª”æ¡ˆçš†å·²å¡«å¯«');

            // é¡¯ç¤ºé€²åº¦
            showStatus("â³ æ­£åœ¨è½‰æ›æª”æ¡ˆæ ¼å¼ä¸¦é©—è­‰ Token...", "blue");
            const file = fileInput.files[0];

            try {
                // A. æª”æ¡ˆè½‰ Base64
                const base64Data = await toBase64(file);
                const rawBase64 = base64Data.split(',')[1];
                const fileName = `${Date.now()}_${file.name.replace(/\s+/g, '_')}`;

                // B. ä¸Šå‚³è‡³ GitHub
                showStatus("â³ æª”æ¡ˆä¸Šå‚³è‡³ GitHub ä¸­...", "blue");
                const ghUrl = `https://api.github.com/repos/${CONFIG.githubRepo}/contents/uploads/${encodeURIComponent(fileName)}`;

                const ghRes = await fetch(ghUrl, {
                    method: 'PUT',
                    headers: {
                        'Authorization': `token ${CONFIG.githubToken}`,
                        'Accept': 'application/vnd.github.v3+json',
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        message: `Upload document: ${fileName}`,
                        content: rawBase64
                    })
                });

                if (!ghRes.ok) {
                    const errDetail = await ghRes.json();
                    if (ghRes.status === 401) throw new Error("Token å·²å¤±æ•ˆï¼è«‹é‡æ–°ç”¢ç”Ÿ Token ä¸¦ä»¥æ‹†è§£æ³•å¡«å…¥ã€‚");
                    throw new Error(`GitHub éŒ¯èª¤: ${errDetail.message}`);
                }

                const ghJson = await ghRes.json();
                const downloadUrl = ghJson.content.download_url;

                // C. å»ºç«‹ FHIR DocumentReference
                showStatus("â³ GitHub æˆåŠŸï¼æ­£åœ¨åŒæ­¥è‡³ FHIR ä¼ºæœå™¨...", "blue");
                const fhirPayload = {
                    resourceType: "DocumentReference",
                    status: "current",
                    subject: { reference: patientId },
                    category: [{ text: category }],
                    content: [{
                        attachment: {
                            contentType: file.type,
                            url: downloadUrl,
                            title: title,
                            creation: new Date().toISOString()
                        }
                    }]
                };

                const fhirRes = await fetch(`${CONFIG.fhirBaseUrl}/DocumentReference`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/fhir+json' },
                    body: JSON.stringify(fhirPayload)
                });

                if (fhirRes.ok) {
                    showStatus("ğŸ‰ ä¸Šå‚³æˆåŠŸï¼æ–‡ä»¶å·²æˆåŠŸé—œè¯è‡³æ‚¨çš„é†«ç™‚ç´€éŒ„ã€‚", "green");
                    document.getElementById('docTitle').value = ""; // æ¸…ç©ºæ¨™é¡Œ
                    fetchDocuments(); // é‡æ–°æ•´ç†åˆ—è¡¨
                } else {
                    throw new Error("FHIR ä¼ºæœå™¨æ‹’çµ•å»ºç«‹ç´€éŒ„ï¼Œè«‹æª¢æŸ¥ API è·¯å¾‘ã€‚");
                }

            } catch (err) {
                showStatus(`âŒ éŒ¯èª¤: ${err.message}`, "red");
                console.error(err);
            }
        }

        // --- æ ¸å¿ƒåŠŸèƒ½ 2ï¼šæŸ¥è©¢æ¸…å–® ---
        async function fetchDocuments() {
            const patientId = document.getElementById('patientId').value;
            const docList = document.getElementById('docList');

            try {
                const res = await fetch(`${CONFIG.fhirBaseUrl}/DocumentReference?subject=${patientId}&_sort=-_lastUpdated&_count=10`);
                if (!res.ok) throw new Error("ç„¡æ³•é€£æ¥ FHIR ä¼ºæœå™¨");
                
                const bundle = await res.json();
                docList.innerHTML = '';

                if (!bundle.entry || bundle.entry.length === 0) {
                    docList.innerHTML = '<tr><td colspan="4" class="p-8 text-center text-gray-500">æ­¤ç—…äººç›®å‰ç„¡ä»»ä½•ä¸Šå‚³ç´€éŒ„</td></tr>';
                    return;
                }

                bundle.entry.forEach(item => {
                    const res = item.resource;
                    const attach = res.content[0].attachment;
                    const date = attach.creation ? new Date(attach.creation).toLocaleDateString() : 'æœªçŸ¥';
                    
                    const row = `
                        <tr class="hover:bg-gray-50 transition">
                            <td class="p-3 text-sm font-medium text-gray-800">${attach.title || 'ç„¡æ¨™é¡Œ'}</td>
                            <td class="p-3 text-sm text-gray-600">${res.category?.[0]?.text || 'æœªåˆ†é¡'}</td>
                            <td class="p-3 text-sm text-gray-500">${date}</td>
                            <td class="p-3">
                                <a href="${attach.url}" target="_blank" class="inline-block bg-blue-100 text-blue-700 px-3 py-1 rounded text-xs font-bold hover:bg-blue-200">æŸ¥çœ‹æª”æ¡ˆ</a>
                            </td>
                        </tr>
                    `;
                    docList.innerHTML += row;
                });
            } catch (err) {
                docList.innerHTML = `<tr><td colspan="4" class="p-8 text-center text-red-500 font-bold">æŸ¥è©¢å¤±æ•—: ${err.message}</td></tr>`;
            }
        }

        // --- å·¥å…·ï¼šè½‰ Base64 ---
        const toBase64 = file => new Promise((resolve, reject) => {
            const reader = new FileReader();
            reader.readAsDataURL(file);
            reader.onload = () => resolve(reader.result);
            reader.onerror = error => reject(error);
        });

        // --- å·¥å…·ï¼šé¡¯ç¤ºç‹€æ…‹ ---
        function showStatus(msg, color) {
            const div = document.getElementById('status');
            div.innerText = msg;
            div.classList.remove('hidden', 'bg-blue-100', 'text-blue-800', 'bg-red-100', 'text-red-800', 'bg-green-100', 'text-green-800');
            
            if (color === "blue") div.classList.add('bg-blue-100', 'text-blue-800');
            if (color === "red") div.classList.add('bg-red-100', 'text-red-800');
            if (color === "green") div.classList.add('bg-green-100', 'text-green-800');
            div.classList.remove('hidden');
        }

        // åˆå§‹åŒ–
        window.onload = fetchDocuments;
    </script>
</body>
</html>
