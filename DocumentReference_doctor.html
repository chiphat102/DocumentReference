<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>醫護端系統 - 臨床文件管理</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-slate-50 p-4 md:p-8">
    <div class="max-w-6xl mx-auto bg-white p-6 md:p-10 rounded-3xl shadow-2xl border border-slate-200">
        <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-8 border-b pb-6">
            <div>
                <h1 class="text-3xl font-black text-slate-800 tracking-tight">醫護端系統 <span class="text-blue-600">Practitioner</span></h1>
                <p class="text-slate-500 text-sm">Token = FseRRShyS18wfOGwTkjqhE0QhMembX1oeODI 開頭是: ghp_</p>
            </div>
            <div class="mt-4 md:mt-0 flex items-center bg-blue-50 px-4 py-2 rounded-xl">
                <div class="w-3 h-3 bg-blue-500 rounded-full animate-pulse mr-2"></div>
                <span class="text-blue-700 font-bold text-sm">已連線至慈濟 FHIR Server</span>
            </div>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-12 gap-10">
            <div class="lg:col-span-5 space-y-6">
                <section class="bg-slate-50 border border-slate-200 p-6 rounded-2xl shadow-sm">
                    <h2 class="text-lg font-extrabold mb-5 text-slate-700 flex items-center">
                        <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path d="M9 13h6m-3-3v6m5 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path></svg>
                        新增醫療紀錄
                    </h2>
                    <div class="grid grid-cols-2 gap-4">
                        <div class="col-span-2">
                            <label class="block text-xs font-bold text-slate-500 mb-1 uppercase">病人 ID (Subject) *</label>
                            <input type="text" id="patientId" value="Patient/1326" class="w-full border p-2 rounded-lg outline-none focus:ring-2 focus:ring-blue-400">
                        </div>
                        <div class="col-span-2">
                            <label class="block text-xs font-bold text-slate-500 mb-1 uppercase">文件類型 (Type) *</label>
                            <select id="docType" class="w-full border p-2 rounded-lg focus:ring-2 focus:ring-blue-400 font-medium">
                                <option value="Lab Report">檢驗報告 (Lab Report)</option>
                                <option value="Imaging Report">影像報告 (Imaging Report)</option>
                                <option value="Discharge Summary">出院摘要 (Discharge Summary)</option>
                                <option value="Clinical Note">門診紀錄 (Clinical Note)</option>
                                <option value="Certificate">診斷證明書 (Certificate)</option>
                            </select>
                        </div>
                        <div class="col-span-2 md:col-span-1">
                            <label class="block text-xs font-bold text-slate-500 mb-1 uppercase">科別 (Category)</label>
                            <select id="category" class="w-full border p-2 rounded-lg focus:ring-2 focus:ring-blue-400">
                                <option value="General">一般內科</option>
                                <option value="Laboratory">檢驗科</option>
                                <option value="Radiology">放射科</option>
                                <option value="Cardiology">心臟科</option>
                            </select>
                        </div>
                        <div class="col-span-2 md:col-span-1">
                            <label class="block text-xs font-bold text-slate-500 mb-1 uppercase">狀態 (docStatus)</label>
                            <select id="docStatus" class="w-full border p-2 rounded-lg">
                                <option value="preliminary">初稿 (Preliminary)</option>
                                <option value="final">最終 (Final)</option>
                            </select>
                        </div>
                        <div class="col-span-2">
                            <label class="block text-xs font-bold text-slate-500 mb-1 uppercase">文件標題 *</label>
                            <input type="text" id="docTitle" placeholder="例如：血液檢驗報告" class="w-full border p-2 rounded-lg">
                        </div>
                        <div class="col-span-2">
                            <label class="block text-xs font-bold text-slate-500 mb-1 uppercase">選擇報告檔案 (PDF)</label>
                            <input type="file" id="fileInput" class="text-sm block w-full text-slate-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100">
                        </div>
                    </div>
                    <button onclick="handleDoctorUpload()" class="mt-6 w-full bg-slate-800 text-white font-black py-4 rounded-xl hover:bg-blue-700 transition duration-300 shadow-lg">
                        確認上傳並建立臨床紀錄
                    </button>
                    <div id="status" class="mt-4 p-4 rounded-xl hidden text-center text-sm font-bold"></div>
                </section>
            </div>

            <div class="lg:col-span-7 space-y-6">
                <section class="border border-slate-200 rounded-3xl overflow-hidden shadow-sm bg-white">
                    <div class="bg-slate-50 p-6 border-b flex justify-between items-center">
                        <h2 class="font-bold text-slate-700 uppercase tracking-widest text-sm">病人文件列表調閱</h2>
                        <button onclick="fetchPatientDocs()" class="bg-white border border-slate-300 text-slate-600 px-4 py-1 rounded-lg hover:bg-slate-100 font-bold text-xs transition">
                            刷新列表
                        </button>
                    </div>

                    <div class="overflow-x-auto">
                        <table class="w-full text-sm text-left border-collapse">
                            <thead>
                                <tr class="text-slate-400 border-b border-slate-100">
                                    <th class="p-4 font-bold uppercase tracking-tighter">標題 / 類型</th>
                                    <th class="p-4 font-bold uppercase tracking-tighter text-center">狀態</th>
                                    <th class="p-4 font-bold uppercase tracking-tighter">日期</th>
                                    <th class="p-4 font-bold uppercase tracking-tighter text-right">操作</th>
                                </tr>
                            </thead>
                            <tbody id="docList" class="divide-y divide-slate-50 text-slate-700 font-medium">
                                </tbody>
                        </table>
                    </div>
                </section>
            </div>
        </div>
    </div>

    <script>
        const CONFIG = {
            githubRepo: 'chiphat102/DocumentReference', 
            fhirBaseUrl: 'https://tzuchi-fhir.ddns.net/fhir'
        };

        async function handleDoctorUpload() {
            const patientId = document.getElementById('patientId').value;
            const docType = document.getElementById('docType').value;
            const title = document.getElementById('docTitle').value;
            const fileInput = document.getElementById('fileInput');

            if (!fileInput.files[0] || !title) return alert("請完整填寫必填欄位。");
            const userToken = prompt("請輸入 GitHub Token (需 repo 權限)");
            if (!userToken) return;

            showStatus("⏳ 正在處理上傳...", "blue");

            try {
                const base64 = await toBase64(fileInput.files[0]);
                const fileName = `practitioner_${Date.now()}_${fileInput.files[0].name.replace(/\s+/g, '_')}`;
                
                // 1. 上傳 GitHub
                const ghUrl = `https://api.github.com/repos/${CONFIG.githubRepo}/contents/uploads/${encodeURIComponent(fileName)}`;
                const ghRes = await fetch(ghUrl, {
                    method: 'PUT',
                    headers: {
                        'Authorization': `token ${userToken.trim()}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ message: `Medical Upload: ${fileName}`, content: base64.split(',')[1] })
                });

                if (!ghRes.ok) throw new Error("GitHub 上傳失敗，請檢查 Token");
                const ghJson = await ghRes.json();

                // 2. 建立 FHIR DocumentReference
                const payload = {
                    resourceType: "DocumentReference",
                    status: "current",
                    docStatus: document.getElementById('docStatus').value,
                    subject: { reference: patientId },
                    type: { text: docType }, // 套用下拉選單之 Type
                    category: [{ text: document.getElementById('category').value }],
                    content: [{
                        attachment: {
                            contentType: fileInput.files[0].type,
                            url: ghJson.content.download_url,
                            title: title,
                            creation: new Date().toISOString()
                        }
                    }]
                };

                const fhirRes = await fetch(`${CONFIG.fhirBaseUrl}/DocumentReference`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/fhir+json' },
                    body: JSON.stringify(payload)
                });

                if (fhirRes.ok) {
                    showStatus("✅ 臨床紀錄建立成功！", "green");
                    fetchPatientDocs();
                } else { throw new Error("FHIR 伺服器同步失敗。"); }

            } catch (err) { showStatus(`❌ 錯誤: ${err.message}`, "red"); }
        }

        async function fetchPatientDocs() {
            const patientId = document.getElementById('patientId').value;
            const docList = document.getElementById('docList');
            docList.innerHTML = '<tr><td colspan="4" class="p-8 text-center text-slate-300 italic">檢索數據中...</td></tr>';

            try {
                const res = await fetch(`${CONFIG.fhirBaseUrl}/DocumentReference?subject=${patientId}&_sort=-_lastUpdated`);
                const bundle = await res.json();
                docList.innerHTML = '';

                if (bundle.entry) {
                    bundle.entry.forEach(item => {
                        const r = item.resource;
                        const a = r.content[0].attachment;
                        const statusColor = r.docStatus === 'final' ? 'text-green-600' : 'text-orange-500';
                        
                        docList.innerHTML += `
                            <tr class="hover:bg-slate-50 transition border-b border-slate-50">
                                <td class="p-4">
                                    <div class="font-bold text-slate-700">${a.title}</div>
                                    <div class="text-[10px] text-slate-400 uppercase font-black">${r.type?.text || 'UNKNOWN TYPE'}</div>
                                </td>
                                <td class="p-4 text-center">
                                    <span class="px-3 py-1 rounded-full text-[10px] font-black uppercase bg-slate-100 ${statusColor}">${r.docStatus || 'PRELIMINARY'}</span>
                                </td>
                                <td class="p-4 text-xs text-slate-400 font-bold">${new Date(a.creation).toLocaleDateString()}</td>
                                <td class="p-4 text-right">
                                    <a href="${a.url}" target="_blank" class="inline-block bg-blue-50 text-blue-600 px-3 py-1 rounded font-black hover:bg-blue-100 text-xs">檢視</a>
                                </td>
                            </tr>`;
                    });
                }
            } catch (e) { docList.innerHTML = '<tr><td colspan="4" class="p-4 text-red-500 font-bold text-center">查詢失敗。</td></tr>'; }
        }

        const toBase64 = file => new Promise((resolve) => {
            const reader = new FileReader();
            reader.readAsDataURL(file);
            reader.onload = () => resolve(reader.result);
        });

        function showStatus(msg, color) {
            const div = document.getElementById('status');
            div.innerText = msg;
            div.className = `mt-4 p-4 rounded-xl block font-bold text-center `;
            if(color === "blue") div.className += "bg-blue-600 text-white";
            if(color === "green") div.className += "bg-green-600 text-white";
            if(color === "red") div.className += "bg-red-600 text-white";
            div.classList.remove('hidden');
        }

        window.onload = fetchPatientDocs;
    </script>
</body>
</html>
